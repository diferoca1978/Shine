---
import MainLayout from "@/layouts/MainLayout.astro";
import {
    generateBreadcrumbSchema,
    generateBlogPostSchema,
    generateFAQSchema,
    type JSONLDSchema,
} from "@/config/seo";
import { AUTHORS, DEFAULT_AUTHOR } from "@/config/authors";
import type { CollectionEntry } from "astro:content";

interface Props {
    post: CollectionEntry<"blog">;
}

const { post } = Astro.props;

// Extract post data for better readability
const { data, id } = post;
const { title, slug, description, pubDate, modifiedDate, image, faqs } = data;

// Sanitize slug: trim whitespace and ensure it's URL-safe
const sanitizedSlug = slug.trim().replace(/\s+/g, "-").toLowerCase();

// Resolve author from AUTHORS array or use default
const author = AUTHORS.find((a) => a.name === data.author) ?? DEFAULT_AUTHOR;

// Generate specific schemas for the post
const postSchema = generateBlogPostSchema({
    title,
    sanitizedSlug,
    description,
    publishDate: pubDate,
    modifiedDate,
    image: image?.src,
    id,
    author: {
        name: author.name,
        role: author.role,
        url: author.url,
        credentials: author.credentials,
    },
});

const breadcrumbSchema = generateBreadcrumbSchema([
    { name: "Inicio", url: "/" },
    { name: "Blog", url: "/blog" },
    { name: title, url: `/blog/${sanitizedSlug}` },
]);

// Build schemas array, including FAQ schema if faqs exist
const aditionalSchemas: JSONLDSchema[] = [
    postSchema,
    breadcrumbSchema,
    ...(faqs && faqs.length > 0 ? [generateFAQSchema(faqs)] : []),
];
---

<MainLayout
    title={sanitizedSlug}
    description={description}
    path={`/blog/${sanitizedSlug}`}
    image={image?.src}
    aditionalSchemas={aditionalSchemas}
>
    <slot />
</MainLayout>
