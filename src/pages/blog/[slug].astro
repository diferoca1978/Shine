---
import PostLayout from "@/layouts/PostLayout.astro";
import { getPosts } from "./blog.api";
import { marked } from "marked";
import hljs from "highlight.js";
import "highlight.js/styles/github-dark.css";
import Prose from "@/components/ui/Prose.astro";
import { getReadingTime } from "@/utils/readinTime";
import { getAuthor, DEFAULT_AUTHOR } from "@/config/authors";

const renderer = new marked.Renderer();
renderer.code = ({ text, lang }) => {
  const validLang = hljs.getLanguage(lang || "plaintext")
    ? lang || "plaintext"
    : "plaintext";
  const highlighted = hljs.highlight(text, { language: validLang }).value;
  return `<pre><code class="hljs ${validLang}">${highlighted}</code></pre>`;
};

marked.setOptions({ renderer });

// Generate all possible paths
export async function getStaticPaths() {
  const posts = await getPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

// Per path let's generate the page
const { post } = Astro.props;

// Get author info from local config (enriches CMS data with bio, credentials, etc.)
const author = getAuthor(post.author) || DEFAULT_AUTHOR;

// Add reading time
const readingTime = post.content ? getReadingTime(post.content) : "";

// Convert markdown to HTML
const postContent = marked(post.content || "");

// Parse dates for layout
const modifiedDate = post.lastUpdate ? new Date(post.lastUpdate) : undefined;

const formatDate = (date: string) =>
  new Date(date).toLocaleDateString("es-CO", {
    day: "numeric",
    month: "short",
    year: "numeric",
  });
---

<PostLayout
  title={post.title}
  description={post.description}
  publishDate={new Date(post.pubDate)}
  modifiedDate={modifiedDate}
  image={post.image.url}
  slug={post.slug}
  author={author}
>
  <article class="container md:mt-0 mx-auto px-2 py-8 md:py-16">
    <nav class="max-w-4xl px-4 sm:px-6 lg:px-8 mx-auto" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2 text-sm text-gray-600">
        <li>
          <a
            href="/"
            class="hover:text-deepdark-900 text-[min(5vw,16px)] transition-colors dark:text-softWhite/80"
            >Inicio</a
          >
        </li>
        <li class="text-deepdark-500 dark:text-softWhite/80">/</li>
        <li>
          <a
            href="/blog"
            class="hover:text-deepdark-900 text-[min(5vw,16px)] transition-colors dark:text-softWhite/80"
            >Blog</a
          >
        </li>
        <li class="text-deepdark-500 dark:text-softWhite/80">/</li>
        <li
          class="text-deepdark-900 text-[min(5vw,16px)] font-bold dark:text-softWhite/80"
          aria-current="page"
        >
          {post.title}
        </li>
      </ol>
    </nav>
    <div class="max-w-5xl px-2 pt-6 lg:pt-10 pb-12 sm:px-6 lg:px-8 mx-auto">
      <div class="flex justify-center h-90 mx-auto">
        <img
          src={post.image.url}
          alt={post.title}
          fetchpriority="high"
          decoding="async"
          class="object-cover w-full h-full rounded-2xl"
        />
      </div>
      <div class="space-y-5 md:space-y-8">
        <h1
          class="text-center font-bold mb-5 text-[min(6vw,36px)] dark:text-softWhite"
        >
          {post.title}
        </h1>
        <p
          class="text-[min(5vw,20px)] text-balance text-center text-deepdark-900 dark:text-softWhite"
        >
          {post.description}
        </p>

        <!-- Author & Post Meta -->
        <div
          class="mb-8 flex flex-col sm:flex-row sm:items-start gap-4 border-y border-deepdark-200 dark:border-softWhite/20 py-4"
        >
          <!-- Author Info -->
          <div class="flex-1">
            <p class="font-medium text-deepdark-900 dark:text-softWhite">
              {author.name}
            </p>
            <p class="text-sm text-deepdark-500 dark:text-softWhite/80">
              {author.role}
            </p>
            <p
              class="text-sm text-deepdark-500 dark:text-softWhite/70 mt-1 max-w-prose"
            >
              {author.bio}
            </p>
          </div>
          <!-- Post Meta -->
          <div
            class="text-sm text-deepdark-500 dark:text-softWhite/80 sm:text-right shrink-0"
          >
            <p>Publicado: {formatDate(post.pubDate)}</p>
            <!-- {
              post.lastUpdate && post.lastUpdate !== post.pubDate && (
                <p>Actualizado: {formatDate(post.lastUpdate)}</p>
              )
            } -->
            <p class="text-deepdark dark:text-softWhite/70">{readingTime}</p>
          </div>
        </div>
      </div>
      <Prose>
        <Fragment set:html={postContent} />
      </Prose>
    </div>
  </article>
</PostLayout>
